<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>openjfx Sdiff modules/javafx.graphics/src/main/native-glass/mac </title>
</head><body id="SUNWwebrev">
<center><a href='../../../../../../modules/javafx.graphics/src/main/native-glass/gtk/GlassRobot.cpp.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../modules/javafx.graphics/src/main/native-glass/win/Robot.cpp.sdiff.html' target='_top'>next &gt</a></center>
<h2>modules/javafx.graphics/src/main/native-glass/mac/GlassRobot.m</h2>
<a class="print" href="javascript:print()">Print this page</a>
<pre>rev <a href="https://bugs.openjdk.java.net/browse/JDK-10767">10767</a> : Move Robot to public API.</pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
 409                 if (data != NULL)
 410                 {
 411                     jint *pixels = (jint*)CFDataGetBytePtr(data);
 412                     if (pixels != NULL)
 413                     {
 414                         color = *pixels;
 415                     }
 416                 }
 417                 CFRelease(data);
 418             }
 419             CGImageRelease(screenImage);
 420         }
 421     }
 422     GLASS_POOL_EXIT;
 423 
 424     return color;
 425 }
 426 
 427 /*
 428  * Class:     com_sun_glass_ui_mac_MacRobot
<span class="changed"> 429  * Method:    _getScreenCapture</span>
<span class="changed"> 430  * Signature: (IIIIZ)Lcom/sun/glass/ui/Pixels;</span>
 431  */
<span class="changed"> 432 JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacRobot__1getScreenCapture</span>
<span class="changed"> 433 (JNIEnv *env, jobject jrobot, jint x, jint y, jint width, jint height, jboolean isHiDPI)</span>
 434 {
<span class="changed"> 435     LOG("Java_com_sun_glass_ui_mac_MacRobot__1getScreenCapture");</span>
 436 
 437     jobject pixels = NULL;
 438 
 439     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
 440     GLASS_POOL_ENTER
 441     {
 442         CGRect bounds = CGRectMake((CGFloat)x, (CGFloat)y, (CGFloat)width, (CGFloat)height);

 443         CGImageRef screenImage = CGWindowListCreateImage(bounds, kCGWindowListOptionOnScreenOnly, kCGNullWindowID, kCGWindowImageDefault);
 444         if (screenImage != NULL)
 445         {
 446             jint pixWidth, pixHeight;
 447 





 448             if (isHiDPI) {
 449                 pixWidth = (jint)CGImageGetWidth(screenImage);
 450                 pixHeight = (jint)CGImageGetHeight(screenImage);
 451             } else {
 452                 pixWidth = width;
 453                 pixHeight = height;
 454             }
 455 
 456             jintArray pixelArray = (*env)-&gt;NewIntArray(env, (jsize)pixWidth*pixHeight);
 457             if (pixelArray)
 458             {
 459                 jint *javaPixels = (jint*)(*env)-&gt;GetIntArrayElements(env, pixelArray, 0);
 460                 if (javaPixels != NULL)
 461                 {
 462                     // create a graphics context around the Java int array
 463                     CGColorSpaceRef picColorSpace = CGColorSpaceCreateWithName(
 464                             kCGColorSpaceGenericRGB);
 465                     CGContextRef jPicContextRef = CGBitmapContextCreate(
 466                             javaPixels,
 467                             pixWidth, pixHeight,
 468                             8, pixWidth * sizeof(jint),
 469                             picColorSpace,
 470                             kCGBitmapByteOrder32Host |
 471                             kCGImageAlphaPremultipliedFirst);
 472 
 473                     CGColorSpaceRelease(picColorSpace);
 474 
 475                     // flip, scale, and color correct the screen image into the Java pixels
 476                     CGRect zeroBounds = { { 0, 0 }, { pixWidth, pixHeight } };
 477                     CGContextDrawImage(jPicContextRef, zeroBounds, screenImage);
 478                     CGContextFlush(jPicContextRef);
 479 
<span class="changed"> 480                     // cleanup</span>
<span class="changed"> 481                     CGContextRelease(jPicContextRef);</span>
<span class="changed"> 482                     (*env)-&gt;ReleaseIntArrayElements(env, pixelArray, javaPixels, 0);</span>
<span class="changed"> 483 </span>
<span class="changed"> 484                     jclass applicationClass =</span>
<span class="changed"> 485                         [GlassHelper ClassForName:"com.sun.glass.ui.Application" withEnv:env];</span>
<span class="changed"> 486                     if (!applicationClass) return NULL;</span>
<span class="changed"> 487 </span>
<span class="changed"> 488                     jfloat scale = (*env)-&gt;CallStaticFloatMethod(env,</span>
<span class="changed"> 489                             applicationClass,</span>
<span class="changed"> 490                             javaIDs.Application.getScaleFactor, x, y, width, height);</span>
<span class="changed"> 491                     if ((*env)-&gt;ExceptionCheck(env)) return NULL;</span>
<span class="changed"> 492 </span>
<span class="changed"> 493                     // create Pixels</span>
<span class="changed"> 494                     pixels = (*env)-&gt;CallStaticObjectMethod(env, applicationClass,</span>
<span class="changed"> 495                                                             javaIDs.Application.createPixels,</span>
<span class="changed"> 496                                                             pixWidth, pixHeight,</span>
<span class="changed"> 497                                                             pixelArray, scale, scale);</span>
<span class="changed"> 498                     if ((*env)-&gt;ExceptionCheck(env)) return NULL;</span>
 499                 }
 500             }
 501 
 502             CGImageRelease(screenImage);
 503         }

 504     }
 505     GLASS_POOL_EXIT;
<span class="removed"> 506 </span>
<span class="removed"> 507     return pixels;</span>
 508 }
</pre></td><td><pre>

</pre><hr></hr><pre>
 409                 if (data != NULL)
 410                 {
 411                     jint *pixels = (jint*)CFDataGetBytePtr(data);
 412                     if (pixels != NULL)
 413                     {
 414                         color = *pixels;
 415                     }
 416                 }
 417                 CFRelease(data);
 418             }
 419             CGImageRelease(screenImage);
 420         }
 421     }
 422     GLASS_POOL_EXIT;
 423 
 424     return color;
 425 }
 426 
 427 /*
 428  * Class:     com_sun_glass_ui_mac_MacRobot
<span class="changed"> 429  * Method:    getScreenCapture</span>
<span class="changed"> 430  * Signature: (IIII[I)V</span>
 431  */
<span class="changed"> 432 JNIEXPORT void JNICALL Java_com_sun_glass_ui_mac_MacRobot_getScreenCapture</span>
<span class="changed"> 433 (JNIEnv *env, jobject jrobot, jint x, jint y, jint width, jint height, jintArray data)</span>
 434 {
<span class="changed"> 435     LOG("Java_com_sun_glass_ui_mac_MacRobot_getScreenCapture");</span>
 436 
 437     jobject pixels = NULL;
 438 
 439     GLASS_ASSERT_MAIN_JAVA_THREAD(env);
 440     GLASS_POOL_ENTER
 441     {
 442         CGRect bounds = CGRectMake((CGFloat)x, (CGFloat)y, (CGFloat)width, (CGFloat)height);
<span class="new"> 443         // installLayoutTestColorProfile();</span>
 444         CGImageRef screenImage = CGWindowListCreateImage(bounds, kCGWindowListOptionOnScreenOnly, kCGNullWindowID, kCGWindowImageDefault);
 445         if (screenImage != NULL)
 446         {
 447             jint pixWidth, pixHeight;
 448 
<span class="new"> 449             jboolean isHiDPI = FALSE;</span>
<span class="new"> 450 </span>
<span class="new"> 451             if ([[NSScreen mainScreen] respondsToSelector:@selector(backingScaleFactor)]) {</span>
<span class="new"> 452                 isHiDPI = [[NSScreen mainScreen] backingScaleFactor] &gt; 1.0;</span>
<span class="new"> 453             }</span>
 454             if (isHiDPI) {
 455                 pixWidth = (jint)CGImageGetWidth(screenImage);
 456                 pixHeight = (jint)CGImageGetHeight(screenImage);
 457             } else {
 458                 pixWidth = width;
 459                 pixHeight = height;
 460             }
 461 
 462             jintArray pixelArray = (*env)-&gt;NewIntArray(env, (jsize)pixWidth*pixHeight);
 463             if (pixelArray)
 464             {
 465                 jint *javaPixels = (jint*)(*env)-&gt;GetIntArrayElements(env, pixelArray, 0);
 466                 if (javaPixels != NULL)
 467                 {
 468                     // create a graphics context around the Java int array
 469                     CGColorSpaceRef picColorSpace = CGColorSpaceCreateWithName(
 470                             kCGColorSpaceGenericRGB);
 471                     CGContextRef jPicContextRef = CGBitmapContextCreate(
 472                             javaPixels,
 473                             pixWidth, pixHeight,
 474                             8, pixWidth * sizeof(jint),
 475                             picColorSpace,
 476                             kCGBitmapByteOrder32Host |
 477                             kCGImageAlphaPremultipliedFirst);
 478 
 479                     CGColorSpaceRelease(picColorSpace);
 480 
 481                     // flip, scale, and color correct the screen image into the Java pixels
 482                     CGRect zeroBounds = { { 0, 0 }, { pixWidth, pixHeight } };
 483                     CGContextDrawImage(jPicContextRef, zeroBounds, screenImage);
 484                     CGContextFlush(jPicContextRef);
 485 
<span class="changed"> 486                     (*env)-&gt;SetIntArrayRegion(env, data, 0, (jsize)pixWidth * pixHeight, pixelArray);</span>


















 487                 }
 488             }
 489 
 490             CGImageRelease(screenImage);
 491         }
<span class="new"> 492         // restoreUserColorProfile();</span>
 493     }
 494     GLASS_POOL_EXIT;


 495 }
</pre></td>
</tr></table>
<center><a href='../../../../../../modules/javafx.graphics/src/main/native-glass/gtk/GlassRobot.cpp.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../modules/javafx.graphics/src/main/native-glass/win/Robot.cpp.sdiff.html' target='_top'>next &gt</a></center>
</body></html>
