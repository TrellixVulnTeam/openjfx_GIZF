<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta charset="utf-8">
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="-1" />
<!--
   Note to customizers: the body of the webrev is IDed as SUNWwebrev
   to allow easy overriding by users of webrev via the userContent.css
   mechanism available in some browsers.

   For example, to have all "removed" information be red instead of
   brown, set a rule in your userContent.css file like:

       body#SUNWwebrev span.removed { color: red ! important; }
-->
<style type="text/css" media="screen">
body {
    background-color: #eeeeee;
}
hr {
    border: none 0;
    border-top: 1px solid #aaa;
    height: 1px;
}
div.summary {
    font-size: .8em;
    border-bottom: 1px solid #aaa;
    padding-left: 1em;
    padding-right: 1em;
}
div.summary h2 {
    margin-bottom: 0.3em;
}
div.summary table th {
    text-align: right;
    vertical-align: top;
    white-space: nowrap;
}
span.lineschanged {
    font-size: 0.7em;
}
span.oldmarker {
    color: red;
    font-size: large;
    font-weight: bold;
}
span.newmarker {
    color: green;
    font-size: large;
    font-weight: bold;
}
span.removed {
    color: brown;
}
span.changed {
    color: blue;
}
span.new {
    color: blue;
    font-weight: bold;
}
a.print { font-size: x-small; }

</style>

<style type="text/css" media="print">
pre { font-size: 0.8em; font-family: courier, monospace; }
span.removed { color: #444; font-style: italic }
span.changed { font-weight: bold; }
span.new { font-weight: bold; }
span.newmarker { font-size: 1.2em; font-weight: bold; }
span.oldmarker { font-size: 1.2em; font-weight: bold; }
a.print {display: none}
hr { border: none 0; border-top: 1px solid #aaa; height: 1px; }
</style>

<title>openjfx Sdiff modules/javafx.graphics/src/main/native-glass/gtk </title>
</head><body id="SUNWwebrev">
<center><a href='../../../../../../modules/javafx.graphics/src/main/java/module-info.java.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../modules/javafx.graphics/src/main/native-glass/mac/GlassRobot.m.sdiff.html' target='_top'>next &gt</a></center>
<h2>modules/javafx.graphics/src/main/native-glass/gtk/GlassRobot.cpp</h2>
<a class="print" href="javascript:print()">Print this page</a>
<pre>rev <a href="https://bugs.openjdk.java.net/browse/JDK-10767">10767</a> : Move Robot to public API.</pre>

<table><tr valign="top">
<td><pre>

</pre><hr></hr><pre>
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 #include &lt;X11/Xlib.h&gt;
  26 #include &lt;X11/Xutil.h&gt;
  27 #include &lt;X11/extensions/XTest.h&gt;
  28 #include &lt;assert.h&gt;
  29 #include &lt;stdlib.h&gt;
  30 #include &lt;math.h&gt;
  31 #include &lt;gdk/gdk.h&gt;
  32 #include &lt;gdk/gdkx.h&gt;
  33 

  34 #include &lt;com_sun_glass_ui_gtk_GtkRobot.h&gt;
  35 #include &lt;com_sun_glass_events_MouseEvent.h&gt;
  36 #include "glass_general.h"
  37 #include "glass_key.h"
  38 #include "glass_screen.h"
  39 
  40 
  41 static void checkXTest(JNIEnv* env) {
  42     int32_t major_opcode, first_event, first_error;
  43     int32_t  event_basep, error_basep, majorp, minorp;
  44     static int32_t isXTestAvailable;
  45     static gboolean checkDone = FALSE;
  46     if (!checkDone) {
  47         /* check if XTest is available */
  48         isXTestAvailable = XQueryExtension(gdk_x11_get_default_xdisplay(), XTestExtensionName, &amp;major_opcode, &amp;first_event, &amp;first_error);
  49         if (isXTestAvailable) {
  50             /* check if XTest version is OK */
  51             XTestQueryExtension(gdk_x11_get_default_xdisplay(), &amp;event_basep, &amp;error_basep, &amp;majorp, &amp;minorp);
  52             if (majorp &lt; 2 || (majorp == 2 &amp;&amp; minorp &lt; 2)) {
  53                     isXTestAvailable = False;

</pre><hr></hr><pre>
 125 JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1mouseMove
 126   (JNIEnv *env, jobject obj, jint x, jint y)
 127 {
 128     (void)obj;
 129 
 130     Display *xdisplay = gdk_x11_get_default_xdisplay();
 131     checkXTest(env);
 132     jfloat uiScale = getUIScale();
 133     x = rint(x * uiScale);
 134     y = rint(y * uiScale);
 135     XWarpPointer(xdisplay,
 136             None,
 137             XRootWindow(xdisplay,gdk_x11_get_default_screen()),
 138             0, 0, 0, 0, x, y);
 139     XSync(xdisplay, False);
 140 }
 141 
 142 static void mouseButtons(jint buttons, gboolean press)
 143 {
 144     Display *xdisplay = gdk_x11_get_default_xdisplay();
<span class="changed"> 145     if (buttons &amp; com_sun_glass_ui_gtk_GtkRobot_MOUSE_LEFT_BTN) {</span>
 146         XTestFakeButtonEvent(xdisplay, 1, press, CurrentTime);
 147     }
<span class="changed"> 148     if (buttons &amp; com_sun_glass_ui_gtk_GtkRobot_MOUSE_MIDDLE_BTN) {</span>
 149         XTestFakeButtonEvent(xdisplay, 2, press, CurrentTime);
 150     }
<span class="changed"> 151     if (buttons &amp; com_sun_glass_ui_gtk_GtkRobot_MOUSE_RIGHT_BTN) {</span>
 152         XTestFakeButtonEvent(xdisplay, 3, press, CurrentTime);
 153     }
 154 
 155     XSync(xdisplay, False);
 156 }
 157 
 158 /*
 159  * Class:     com_sun_glass_ui_gtk_GtkRobot
 160  * Method:    _mousePress
 161  * Signature: (I)V
 162  */
 163 JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1mousePress
 164   (JNIEnv *env, jobject obj, jint buttons)
 165 {
 166     (void)obj;
 167 
 168     checkXTest(env);
 169     mouseButtons(buttons, TRUE);
 170 }
 171 

</pre><hr></hr><pre>
 223 }
 224 
 225 /*
 226  * Class:     com_sun_glass_ui_gtk_GtkRobot
 227  * Method:    _getMouseY
 228  * Signature: ()I
 229  */
 230 JNIEXPORT jint JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1getMouseY
 231   (JNIEnv *env, jobject obj)
 232 {
 233     (void)env;
 234     (void)obj;
 235 
 236     jint y;
 237     glass_gdk_display_get_pointer(gdk_display_get_default(), NULL, &amp;y);
 238     return y;
 239 }
 240 
 241 /*
 242  * Class:     com_sun_glass_ui_gtk_GtkRobot
<span class="changed"> 243  * Method:    _getScreenCapture</span>
 244  * Signature: (IIII[I)V
 245  */
<span class="changed"> 246 JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1getScreenCapture</span>
 247   (JNIEnv * env, jobject obj, jint x, jint y, jint width, jint height, jintArray data)
 248 {
 249     (void)obj;
 250 
 251     GdkPixbuf *screenshot, *tmp;
 252     GdkWindow *root_window = gdk_get_default_root_window();
 253 
 254     tmp = glass_pixbuf_from_window(root_window, x, y, width, height);
 255     screenshot = gdk_pixbuf_add_alpha(tmp, FALSE, 0, 0, 0);
 256     g_object_unref(tmp);
 257 
 258     jint *pixels = (jint *)convert_BGRA_to_RGBA((int*)gdk_pixbuf_get_pixels(screenshot), width * 4, height);
 259     env-&gt;SetIntArrayRegion(data, 0, height * width, pixels);
 260     g_free(pixels);
 261 
 262     g_object_unref(screenshot);
 263 }
 264 
 265 } // extern "C"
</pre></td><td><pre>

</pre><hr></hr><pre>
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 #include &lt;X11/Xlib.h&gt;
  26 #include &lt;X11/Xutil.h&gt;
  27 #include &lt;X11/extensions/XTest.h&gt;
  28 #include &lt;assert.h&gt;
  29 #include &lt;stdlib.h&gt;
  30 #include &lt;math.h&gt;
  31 #include &lt;gdk/gdk.h&gt;
  32 #include &lt;gdk/gdkx.h&gt;
  33 
<span class="new">  34 #include &lt;com_sun_glass_ui_GlassRobot.h&gt;</span>
  35 #include &lt;com_sun_glass_ui_gtk_GtkRobot.h&gt;
  36 #include &lt;com_sun_glass_events_MouseEvent.h&gt;
  37 #include "glass_general.h"
  38 #include "glass_key.h"
  39 #include "glass_screen.h"
  40 
  41 
  42 static void checkXTest(JNIEnv* env) {
  43     int32_t major_opcode, first_event, first_error;
  44     int32_t  event_basep, error_basep, majorp, minorp;
  45     static int32_t isXTestAvailable;
  46     static gboolean checkDone = FALSE;
  47     if (!checkDone) {
  48         /* check if XTest is available */
  49         isXTestAvailable = XQueryExtension(gdk_x11_get_default_xdisplay(), XTestExtensionName, &amp;major_opcode, &amp;first_event, &amp;first_error);
  50         if (isXTestAvailable) {
  51             /* check if XTest version is OK */
  52             XTestQueryExtension(gdk_x11_get_default_xdisplay(), &amp;event_basep, &amp;error_basep, &amp;majorp, &amp;minorp);
  53             if (majorp &lt; 2 || (majorp == 2 &amp;&amp; minorp &lt; 2)) {
  54                     isXTestAvailable = False;

</pre><hr></hr><pre>
 126 JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1mouseMove
 127   (JNIEnv *env, jobject obj, jint x, jint y)
 128 {
 129     (void)obj;
 130 
 131     Display *xdisplay = gdk_x11_get_default_xdisplay();
 132     checkXTest(env);
 133     jfloat uiScale = getUIScale();
 134     x = rint(x * uiScale);
 135     y = rint(y * uiScale);
 136     XWarpPointer(xdisplay,
 137             None,
 138             XRootWindow(xdisplay,gdk_x11_get_default_screen()),
 139             0, 0, 0, 0, x, y);
 140     XSync(xdisplay, False);
 141 }
 142 
 143 static void mouseButtons(jint buttons, gboolean press)
 144 {
 145     Display *xdisplay = gdk_x11_get_default_xdisplay();
<span class="changed"> 146     if (buttons &amp; com_sun_glass_ui_GlassRobot_MOUSE_LEFT_BTN) {</span>
 147         XTestFakeButtonEvent(xdisplay, 1, press, CurrentTime);
 148     }
<span class="changed"> 149     if (buttons &amp; com_sun_glass_ui_GlassRobot_MOUSE_MIDDLE_BTN) {</span>
 150         XTestFakeButtonEvent(xdisplay, 2, press, CurrentTime);
 151     }
<span class="changed"> 152     if (buttons &amp; com_sun_glass_ui_GlassRobot_MOUSE_RIGHT_BTN) {</span>
 153         XTestFakeButtonEvent(xdisplay, 3, press, CurrentTime);
 154     }
 155 
 156     XSync(xdisplay, False);
 157 }
 158 
 159 /*
 160  * Class:     com_sun_glass_ui_gtk_GtkRobot
 161  * Method:    _mousePress
 162  * Signature: (I)V
 163  */
 164 JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1mousePress
 165   (JNIEnv *env, jobject obj, jint buttons)
 166 {
 167     (void)obj;
 168 
 169     checkXTest(env);
 170     mouseButtons(buttons, TRUE);
 171 }
 172 

</pre><hr></hr><pre>
 224 }
 225 
 226 /*
 227  * Class:     com_sun_glass_ui_gtk_GtkRobot
 228  * Method:    _getMouseY
 229  * Signature: ()I
 230  */
 231 JNIEXPORT jint JNICALL Java_com_sun_glass_ui_gtk_GtkRobot__1getMouseY
 232   (JNIEnv *env, jobject obj)
 233 {
 234     (void)env;
 235     (void)obj;
 236 
 237     jint y;
 238     glass_gdk_display_get_pointer(gdk_display_get_default(), NULL, &amp;y);
 239     return y;
 240 }
 241 
 242 /*
 243  * Class:     com_sun_glass_ui_gtk_GtkRobot
<span class="changed"> 244  * Method:    getScreenCapture</span>
 245  * Signature: (IIII[I)V
 246  */
<span class="changed"> 247 JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkRobot_getScreenCapture</span>
 248   (JNIEnv * env, jobject obj, jint x, jint y, jint width, jint height, jintArray data)
 249 {
 250     (void)obj;
 251 
 252     GdkPixbuf *screenshot, *tmp;
 253     GdkWindow *root_window = gdk_get_default_root_window();
 254 
 255     tmp = glass_pixbuf_from_window(root_window, x, y, width, height);
 256     screenshot = gdk_pixbuf_add_alpha(tmp, FALSE, 0, 0, 0);
 257     g_object_unref(tmp);
 258 
 259     jint *pixels = (jint *)convert_BGRA_to_RGBA((int*)gdk_pixbuf_get_pixels(screenshot), width * 4, height);
 260     env-&gt;SetIntArrayRegion(data, 0, height * width, pixels);
 261     g_free(pixels);
 262 
 263     g_object_unref(screenshot);
 264 }
 265 
 266 } // extern "C"
</pre></td>
</tr></table>
<center><a href='../../../../../../modules/javafx.graphics/src/main/java/module-info.java.sdiff.html' target='_top'>&lt prev</a> <a href='../../../../../../index.html' target='_top'>index</a> <a href='../../../../../../modules/javafx.graphics/src/main/native-glass/mac/GlassRobot.m.sdiff.html' target='_top'>next &gt</a></center>
</body></html>
